SELECT
	CDO.OWNER_SK																									AS OWNER_SK
	, IFNULL(SPAS.DATE_KEY, SPAT.DATE_KEY)																			AS DATE_KEY
	, SPAT.WORKING_HOURS																							AS WORKING_HOURS
	, LEAST(SPAS.ABSENCE_DAYS,1) 																					AS ABSENCE_DAYS
	, IFF(SPAS.ABSENCE_DAYS > 1 AND SPAS.ABSENCE_TYPE LIKE '%sick%','sick_leave', ABSENCE_TYPE) 					AS ABSENCE_TYPE
	, IFF(ABSENCE_DAYS + HOMEOFFICE_DAYS > 1, IFF(1 - ABSENCE_DAYS = 0, NULL, 1 - ABSENCE_DAYS), HOMEOFFICE_DAYS)	AS HOMEOFFICE_DAYS
FROM  {{ ref('staging_personio_attendances') }} SPAT
FULL JOIN  {{ ref('staging_personio_absences') }} SPAS ON (SPAT.DATE_KEY=SPAS.DATE_KEY) AND (SPAT.EMPLOYEE_ID=SPAS.EMPLOYEE_ID)
LEFT JOIN {{ref('core_dim_owner') }} CDO ON IFNULL(SPAS.EMPLOYEE_ID, SPAT.EMPLOYEE_ID) = CDO.PERSONIO_ID
		AND IFNULL(SPAS.DATE_KEY, SPAT.DATE_KEY)  >= CDO.VALID_FROM
		AND IFNULL(SPAS.DATE_KEY, SPAT.DATE_KEY) < CDO.VALID_TO
