{{ config(
    tags=["engagements"]
) }}

SELECT
	SHE.ENGAGEMENT_ID
	, CDD.DEAL_STAGE_SK
	, IFNULL(CDD.DEAL_SK, -1)						AS DEAL_SK
	, CDD.DEAL_STAGE_NAME
	, SHE.CONTACT_ID
	, COALESCE(CDD.COMPANY_SK, CDC.COMPANY_SK, -1)	AS COMPANY_SK
	, CDT.TICKET_SK
	, CDO.OWNER_SK
	, SHE.TEAM_ID
	, SHE.TIMESTAMP_KEY
	, SHE.ENGAGEMENT_TYPE
	, SHE.DURATION_CATEGORY
	, SHE.ACTUAL_DURATION_MIN						AS DURATION_MIN
	, SHE.TOTAL_DURATION_MIN
	, SHE.NUM_CONTACTS
	, SHE.NUM_TICKETS
	, SHE.NUM_COMPANIES
FROM {{ ref('staging_hubspot_engagements') }} SHE
LEFT JOIN {{ ref('core_dim_company') }} CDC ON SHE.COMPANY_ID = CDC.COMPANY_ID
INNER JOIN {{ ref('core_dim_deal') }} CDD ON SHE.DEAL_ID = CDD.DEAL_ID
	AND SHE.TIMESTAMP_KEY >= CDD.VALID_FROM
	AND SHE.TIMESTAMP_KEY < CDD.VALID_TO
LEFT JOIN {{ ref('core_dim_ticket') }} CDT ON SHE.TICKET_ID = CDT.TICKET_ID
	AND SHE.TIMESTAMP_KEY >= CDT.VALID_FROM
	AND SHE.TIMESTAMP_KEY < CDT.VALID_TO
LEFT JOIN {{ ref('core_dim_owner') }} CDO ON SHE.OWNER_ID = CDO.OWNER_ID
	AND SHE.TIMESTAMP_KEY  >= CDO.VALID_FROM
	AND SHE.TIMESTAMP_KEY < CDO.VALID_TO
