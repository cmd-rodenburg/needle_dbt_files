
-- NOTE: SALARY ORIGINATES FROM THE PEX FLATFILE, AS IT CONTAINS BOTH SALARY AND THE SOCIAL SECURITY COSTS
SELECT
	NULL ::BIGINT 													AS RECEIPT_ID
	, NULL ::BIGINT 												AS RECEIPT_LINE_ITEM_ID
	, 0																AS TAX_PERCENTAGE
	, (SFPE.GROSS_SALARY + SFPE.SOCIAL_SECURITY)					AS NET_AMOUNT
	, 0																AS TAX_AMOUNT
	, NET_AMOUNT		 						 					AS GROSS_AMOUNT
	, CONCAT('SC - ', SFPE.EMPLOYEE_NAME)							AS LINE_ITEM_DESCRIPTION
	, TO_TIMESTAMP_TZ(SFPE.DATE_KEY ::TIMESTAMP) 					AS CREATE_TIMESTAMP
	, SFPE.DATE_KEY 												AS DATE_KEY
	, SFPE.DATE_KEY 												AS DELIVERY_DATE
	, SFPE.DATE_KEY 												AS PAY_DATE
	-- NOTE: Salaries are due on the 28th
	, DATEADD(DAY,28,SFPE.DATE_KEY)									AS DUE_DATE
	, IFNULL(SSC.CONTACT_ID,
		REPLACE(SFPE.EMPLOYEE_ID, 'ID', '') ::BIGINT	)			AS DEBTORS_CREDITORS_ID
	, 'C' 															AS CREDIT_DEBIT
	, CONCAT(TO_CHAR(SFPE.DATE_KEY, 'MM/YY') , '_10470_Salary')		AS DESCRIPTION
	, NULL 															AS DOCUMENT_ID
	, NULL															AS COST_CENTRE_ID
	, NULL 															AS ORIGIN_ID
	, NULL 															AS IBAN
	, NULL 															AS VAT_NUMBER
	, 'SEPAcredit' 													AS TAGS
	, SPE.DEPARTMENT												AS COST_CENTRE
	, 'Personnel expenses'											AS ACCOUNTING_CATEGORY
	, 'Paid' 														AS PAYMENT_STATUS
	, 'One-off' 													AS RECURRENCE
	, NULL 															AS RECURRING_INTERVAL
FROM {{ ref('staging_flatfiles_personnel_expenses') }} SFPE
LEFT JOIN {{ ref('staging_sevdesk_contacts') }} SSC ON SSC.CONTACT_NAME = SFPE.EMPLOYEE_NAME
LEFT JOIN {{ ref('staging_personio_employees') }} spe  ON SFPE.EMPLOYEE_NAME = SPE.EMPLOYEE_NAME AND SPE.ACTIVE_INDICATOR = TRUE

UNION ALL

SELECT
	SSR.RECEIPT_ID
	, SSR.RECEIPT_LINE_ITEM_ID
	, SSR.TAX_PERCENTAGE
	, SSR.NET_AMOUNT
	, SSR.TAX_AMOUNT
	, SSR.GROSS_AMOUNT
	, SSR.LINE_ITEM_DESCRIPTION
	, SSR.CREATE_TIMESTAMP
	, SSR.DATE_KEY
	, SSR.DELIVERY_DATE
	, SSR.PAY_DATE
	, SSR.DUE_DATE
	, SSR.CONTACT_ID 			AS DEBTORS_CREDITORS_ID
	, SSR.CREDIT_DEBIT
	, SSR.RECEIPT_DESCRIPTION
	, SSR.DOCUMENT_ID
	, SSR.COST_CENTRE_ID
	, SSR.ORIGIN_ID
	, SSR.IBAN
	, SSR.VAT_NUMBER
	, SSR.TAGS
	, SSR.COST_CENTRE
	, SSR.ACCOUNTING_CATEGORY
	, SSR.PAYMENT_STATUS
	, SSR.RECURRENCE
	, SSR.RECURRING_INTERVAL
FROM {{ ref('staging_sevdesk_receipts') }} SSR
LEFT JOIN {{ ref('staging_sevdesk_contacts') }} SSC USING (CONTACT_ID)
WHERE CONTACT_NAME NOT IN ('Salary' , 'Salary tax / social security')
