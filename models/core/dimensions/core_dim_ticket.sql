{{ config(
    tags=["tickets"]
) }}

WITH TICKET_STAGES AS (

	SELECT
		DENSE_RANK () OVER (ORDER BY STAGE_ID, STAGE_NAME)	AS TICKET_STAGE_SK
		, STAGE_ID											AS TICKET_STAGE_ID
		, STAGE_NAME										AS TICKET_STAGE_NAME
		, IS_CLOSED
	FROM {{ ref('staging_hubspot_pipelines') }}
	WHERE OBJECT_TYPE = 'tickets'

)
, TICKET_CLEAN AS (
	SELECT
		ROW_NUMBER() OVER (ORDER BY TICKET_ID, MIN(VALID_FROM))			AS TICKET_STAGE_SK
		, TICKET_ID
		, TICKET_STAGE_NAME
		, IS_CLOSED
		, OWNER_ID
		, ISLAND_ID
		, IFF(MIN(RN_) = 1, MIN(CREATE_DATE), MIN(VALID_FROM)) 			AS VALID_FROM
		, MAX(VALID_TO) 												AS VALID_TO
	FROM (
		SELECT *
			, SUM(CASE WHEN PREVIOUS_STAGE = HASH_  THEN 0 ELSE 1 END) OVER (PARTITION BY TICKET_ID ORDER BY VALID_TO) 	AS ISLAND_ID
		FROM (
			SELECT SHT.TICKET_ID
				, TS.TICKET_STAGE_NAME
				, TS.IS_CLOSED
				, SHT.OWNER_ID
				, SHT.CREATE_DATE
				, HASH(SHT.TICKET_ID, TS.TICKET_STAGE_NAME, SHT.OWNER_ID) 										AS HASH_
				, LAG(HASH_) OVER (PARTITION BY SHT.TICKET_ID ORDER BY VALID_TO, VALID_FROM) 					AS PREVIOUS_STAGE
				, ROW_NUMBER() OVER (PARTITION BY SHT.TICKET_ID ORDER BY SHT.TICKET_ID, VALID_TO, VALID_FROM) 	AS RN_
				, SHT.VALID_FROM
				, SHT.VALID_TO
			FROM {{ ref('staging_hubspot_tickets') }} SHT
			LEFT JOIN TICKET_STAGES TS USING (TICKET_STAGE_ID)
		) a
	) a
	GROUP BY TICKET_ID
		, TICKET_STAGE_NAME
		, IS_CLOSED
		, OWNER_ID
		, ISLAND_ID
)

SELECT
	DENSE_RANK ()	OVER (ORDER BY su.TICKET_ID)		AS TICKET_SK
	, su.TICKET_STAGE_SK
	, su.TICKET_ID
	, IFNULL(CDO.OWNER_SK, -1)							AS OWNER_SK
	, COALESCE(CDD.COMPANY_SK, CDC.COMPANY_SK , -1)		AS COMPANY_SK
	, IFNULL(CDD.DEAL_SK, -1)							AS DEAL_SK
	, PIP.PIPELINE_NAME
	, su.TICKET_STAGE_NAME
	, su.IS_CLOSED
	, sht.TICKET_NAME
	, sht.CREATE_DATE
	, sht.CLOSED_DATE
	, sht.LAST_ACTIVITY
	, sht.NUM_COMPANIES
	, sht.NUM_DEALS
	, sht.NUM_CONTACTS
	, sht.TIMES_CONTACTED
	, sht.FIRST_REPLY_DATE
	, sht.TIME_TO_FIRST_CONTACT
	, sht.TIME_TO_CLOSE
	, sht.TIME_TO_SOLUTION
	, sht.FIRST_CONTACT_RESOLUTION
	, sht.IS_ARCHIVED
	, sht.TICKET_ASSIGNEE
	, SHT.TICKET_PRIORITY
	, sht.ORIGINAL_PRIORITY
	, sht.TICKET_CATEGORY
	, sht.SERVICE_KATALOG
	, sht.PORTAL
	, sht.PRODUCT
	, sht.RESOLUTION
	, sht.FEEDBACK_RATING
	, SU.VALID_FROM
	, SU.VALID_TO
	, IFF(SU.VALID_TO = '9999-12-31', TRUE, FALSE)		AS ACTIVE_INDICATOR
FROM TICKET_CLEAN su
LEFT JOIN {{ ref('staging_hubspot_tickets') }} 	sht ON sht.TICKET_ID = su.ticket_id AND sht.active_indicator = TRUE
LEFT JOIN {{ ref('core_dim_deal') }}			CDD ON CDD.DEAL_ID = SHT.DEAL_ID AND CDD.ACTIVE_INDICATOR = TRUE
LEFT JOIN {{ ref('core_dim_company') }} 		CDC ON sht.COMPANY_ID = CDC.COMPANY_ID
LEFT JOIN {{ ref('core_dim_owner') }} 			CDO ON sht.OWNER_ID = CDO.OWNER_ID AND CDO.ACTIVE_INDICATOR = TRUE
LEFT JOIN (
	SELECT DISTINCT PIPELINE_ID
		, PIPELINE_NAME
	FROM {{ ref('staging_hubspot_pipelines') }}) PIP ON sht.PIPELINE_ID = pip.PIPELINE_ID