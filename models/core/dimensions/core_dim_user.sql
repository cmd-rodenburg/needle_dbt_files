WITH FAQ AS (
	SELECT CONTACT_ID																	AS CONTACT_ID
		, SUM(IFF(SURVEY_TYPE = 'Frequently asked questions', FEEDBACK_RESULT, NULL)) 	AS FREQUENTLY_ASKED_QUESTIONS_RESULT_SUM
		, COUNT(IFF(SURVEY_TYPE = 'Frequently asked questions', FEEDBACK_RESULT, NULL)) AS FREQUENTLY_ASKED_QUESTIONS_COUNT
		, SUM(IFF(SURVEY_TYPE = 'Customer effort score', FEEDBACK_RESULT, NULL))		AS CUSTOMER_EFFORT_SCORE_RESULT_SUM
		, COUNT(IFF(SURVEY_TYPE = 'Customer effort score', SURVEY_TYPE, NULL))			AS CUSTOMER_EFFORT_SCORE_COUNT
	FROM {{ ref('staging_hubspot_feedback_submissions') }}
	GROUP BY CONTACT_ID
)

-- NOTE: LEFT JOIN ON CDC2 TO INCLUDE THE COMPANY_SK FOR THE OPERATING CUSTOMER (E.G. OPERATIONAL_COMPANY = KOSTAL FOR KOSTAL'S SUBCONTRACTOR)
SELECT DISTINCT
	-- NOTE: CONCAT AS THE USER_ID AND CONTACT_ID CAN OVERLAP
	DENSE_RANK() OVER (ORDER BY IFNULL(HUBSPOT_CONTACT_ID::TEXT, CONCAT(OPERATIONAL_USER_ID::TEXT, 'ID')))	AS USER_SK
	, shc.HUBSPOT_CONTACT_ID						AS HUBSPOT_USER_ID
	, shc.OPERATIONAL_USER_ID	 					AS USER_ID
	, IFNULL(CDC.COMPANY_SK, -1)					AS COMPANY_SK
	, IFNULL(CDC2.COMPANY_SK, -1)					AS OPERATIONAL_COMPANY_SK
	, shc.CREATED_AT								AS CREATED_AT
 	, shc.CONTACT_COUNTRY							AS COUNTRY
	, shc.CONTACT_LANGUAGE							AS LANGUAGE
	, shc.JOB_TITLE									AS JOB_TITLE
	, shc.JOB_FUNCTION								AS JOB_FUNCTION
	, shc.HUBSPOT_SCORE								AS HUBSPOT_SCORE
	, shc.LAST_LOGIN								AS LAST_LOGIN
	, shc.BLOCKED									AS IS_BLOCKED
	, shc.LOCKOUT_ENABLED							AS LOCKOUT_ENABLED
	, shc.SOLYTIC_EMPLOYEE							AS SOLYTIC_EMPLOYEE
	, shc.USERNAME									AS USERNAME
	, faq.FREQUENTLY_ASKED_QUESTIONS_RESULT_SUM		AS FREQUENTLY_ASKED_QUESTIONS_RESULT_SUM
	, faq.FREQUENTLY_ASKED_QUESTIONS_COUNT			AS FREQUENTLY_ASKED_QUESTIONS_COUNT
	, faq.CUSTOMER_EFFORT_SCORE_RESULT_SUM			AS CUSTOMER_EFFORT_SCORE_RESULT_SUM
	, faq.CUSTOMER_EFFORT_SCORE_COUNT				AS CUSTOMER_EFFORT_SCORE_COUNT
FROM {{ ref('staging_hubspot_contacts') }} shc
LEFT JOIN {{ ref('core_dim_company') }} cdc ON shc.HUBSPOT_COMPANY_ID = cdc.COMPANY_ID
LEFT JOIN {{ ref('core_dim_company') }} cdc2 ON shc.OPERATIONAL_COMPANY_ID = CDC2.OPERATIONAL_ID
LEFT JOIN FAQ faq ON (shc.HUBSPOT_CONTACT_ID = faq.CONTACT_ID)

