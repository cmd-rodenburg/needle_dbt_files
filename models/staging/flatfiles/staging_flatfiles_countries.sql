-- NOTE: EACH COUNTRY HAS MULTIPLE LANGUAGES HOWEVER ONLY ONE GEOMETRY. THE ENGLISH LANGUAGE IS THE DEFAULT

WITH main_names AS (

	SELECT ID
		, "name"
		, ALPHA3
	FROM  {{ source('flatfiles', 'countries') }}
	WHERE "LANGUAGE" = 'en'

)

SELECT	IFNULL(CC.ID, 1000 + DENSE_RANK () OVER (ORDER BY CG.COUNTRY_NAME))				AS COUNTRY_ID
	, IFNULL(MN."name", CG.COUNTRY_NAME) 												AS COUNTRY_NAME
	, COALESCE(CC."name", CG.COUNTRY_NAME)												AS COUNTRY_NAME_LOCAL
	, CG.COUNTRY_GEOGRAPHY
	, IFNULL(CC."LANGUAGE", 'en')														AS LANGUAGE
	, IFF(CG.COUNTRY_ALPHA_3 = '-99' OR CC.ALPHA3 IS NULL,'UNKNOWN', UPPER(CC.ALPHA2))	AS COUNTRY_ALPHA_2_CODE
	, IFF(CG.COUNTRY_ALPHA_3 = '-99' OR CC.ALPHA3 IS NULL,'UNKNOWN', UPPER(CC.ALPHA3))	AS COUNTRY_ALPHA_3_CODE
FROM {{ source('flatfiles', 'geographies') }} CG
FULL join {{ source('flatfiles', 'countries') }}  CC on LOWER(CG.COUNTRY_ALPHA_3) = CC.ALPHA3
LEFT JOIN main_names MN ON CC.ALPHA3 = MN.ALPHA3

