WITH UNION_ALL AS (
	SELECT DATE											AS DATE_KEY
		, INITCAP(SUBSCRIPTIONNAME)						AS SUBSCRIPTION_NAME 		--PBI
		, lower(SUBSCRIPTIONID)							AS SUBSCRIPTION_ID
		, lower(RESOURCEGROUPNAME)						AS RESOURCE_GROUP_NAME
		, lower(RESOURCEID)							 	AS RESOURCE_ID 				--PBI
		, SPLIT_PART(lower(RESOURCE_ID), '/', 8) 		AS RESOURCE_TYPE
		, SPLIT_PART(lower(RESOURCE_ID), '/', 9) 		AS RESOURCE_NAME
		, PRODUCTNAME									AS PRODUCT_NAME
		, SERVICEFAMILY								 	AS SERVICE_FAMILY
		, REPLACE(lower(CONSUMEDSERVICE), 'microsoft.')	AS CONSUMED_SERVICE
		, METERID										AS METER_ID
		, METERNAME										AS METER_NAME				--PBI
		, METERCATEGORY									AS METER_CATEGORY
		, METERSUBCATEGORY								AS METER_SUBCATEGORY
		, UNITOFMEASURE									AS UNIT_OF_MEASURE
		, CHARGETYPE									AS CHARGE_TYPE				--PBI
		, COSTINBILLINGCURRENCY							AS COST_IN_EUR	--PBI
		, COSTINUSD										AS COST_IN_USD
		, ADDITIONALINFO								AS ADDITIONAL_INFO
		, TAGS											AS TAGS
		, TAGS:"Component"::string						AS TAG_COMPONENT
		, UPPER(IFNULL(TAGS:"Environment"::string, TAGS:"ENVIRONMENT"::string))		AS TAG_ENVIRONMENT
	FROM {{ source('flatfiles', 'azure_costs') }} az
	WHERE ENTRY_DATE IN (
		SELECT MAX(ENTRY_DATE)
		FROM {{ source('flatfiles', 'azure_costs') }}
		GROUP BY YEAR(ENTRY_DATE),
			MONTH(ENTRY_DATE)
		)

	UNION ALL

	SELECT DATE											AS DATE_KEY
		, INITCAP(SUBSCRIPTIONNAME)						AS SUBSCRIPTION_NAME 		--PBI
		, lower(SUBSCRIPTIONID)							AS SUBSCRIPTION_ID
		, lower(RESOURCEGROUPNAME)						AS RESOURCE_GROUP_NAME
		, lower(RESOURCEID)							 	AS RESOURCE_ID 				--PBI
		, SPLIT_PART(lower(RESOURCE_ID), '/', 8)		AS RESOURCE_TYPE
		, SPLIT_PART(lower(RESOURCE_ID), '/', 9) 		AS RESOURCE_NAME
		, PRODUCT										AS PRODUCT_NAME
		, SERVICEFAMILY								 	AS SERVICE_FAMILY
		, REPLACE(lower(CONSUMEDSERVICE), 'microsoft.')	AS CONSUMED_SERVICE
		, METERID										AS METER_ID
		, METERNAME										AS METER_NAME				--PBI
		, METERCATEGORY									AS METER_CATEGORY
		, METERSUBCATEGORY								AS METER_SUBCATEGORY
		, UNITOFMEASURE									AS UNIT_OF_MEASURE
		, CHARGETYPE									AS CHARGE_TYPE				--PBI
		, COSTINBILLINGCURRENCY							AS COST_IN_EUR	--PBI
		, REPLACE(COSTINUSD, '''', '') :: FLOAT			AS COST_IN_USD
		, ADDITIONALINFO								AS ADDITIONAL_INFO
		, TAGS											AS TAGS
		, TAGS:"Component"::string						AS TAG_COMPONENT
		, UPPER(IFNULL(TAGS:"Environment"::string, TAGS:"ENVIRONMENT"::string))		AS TAG_ENVIRONMENT
	FROM {{ source('flatfiles', 'azure_costs_history') }} az

)

SELECT DATE_KEY
	, IFF(SUBSCRIPTION_NAME	= '' OR SUBSCRIPTION_NAME IS NULL, CHARGE_TYPE, SUBSCRIPTION_NAME) AS SUBSCRIPTION_NAME
	, IFF(SUBSCRIPTION_ID		= '', NULL, SUBSCRIPTION_ID	 	) AS SUBSCRIPTION_ID
	, IFF(RESOURCE_GROUP_NAME	= '', NULL, RESOURCE_GROUP_NAME ) AS RESOURCE_GROUP_NAME
	, IFF(RESOURCE_ID			= '', NULL, RESOURCE_ID		 	) AS RESOURCE_ID
	, IFF(RESOURCE_TYPE 		= '', NULL,	RESOURCE_TYPE		) AS RESOURCE_TYPE
	, IFF(RESOURCE_NAME			= '', NULL, RESOURCE_NAME		) AS RESOURCE_NAME
	, PRODUCT_NAME
	, SERVICE_FAMILY
	, CONSUMED_SERVICE
	, METER_ID
	, IFF(METER_NAME			= '', NULL, METER_NAME		 	) AS METER_NAME
	, METER_CATEGORY
	, METER_SUBCATEGORY
	, UNIT_OF_MEASURE
	, CHARGE_TYPE
	, COST_IN_EUR	--PBI
	, COST_IN_USD
	, IFF(ADDITIONAL_INFO		= '', NULL, ADDITIONAL_INFO		) AS ADDITIONAL_INFO
	, TAGS
	, TAG_COMPONENT
	, TAG_ENVIRONMENT
FROM UNION_ALL