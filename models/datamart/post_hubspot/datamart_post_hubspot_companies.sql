-- NOTE: THE TABLE SUMMARISES THE PORTAL INFORMATION WHICH ARE POSTED TO HUBSPOT COMPANIES
-- NOTE: DO NOT CHANGE THE COLUMN ORDER ETC. WITHOUT UPDATING DATA-LOADING
WITH LOGINS AS (

    SELECT
        OPERATIONAL_COMPANY_SK
        , MAX(LAST_LOGIN)               AS LAST_LOGIN
    FROM  {{ ref('core_dim_user') }}
    GROUP BY OPERATIONAL_COMPANY_SK

)
, CONTRACTS AS (

    SELECT
        COMPANY_SK
        , SUM(SINGLE_SITES)                 AS SIGNED_SITES
        , SUM(VOLUME_BASED_MWP)             AS SIGNED_MWP
    FROM {{ ref('core_dim_deal') }}
    WHERE ACTIVE_INDICATOR = TRUE
        AND DEAL_STAGE_NAME = 'Won'
        AND CURRENT_DATE BETWEEN CONTRACT_START_DATE AND CONTRACT_END_DATE
    GROUP BY COMPANY_SK

)
, SITES AS (

    SELECT
        COMPANY_SK
        , COUNT(SITE_SK)                                                    ::INT 	AS TOTAL_SITES
        , ROUND(SUM(CAPACITY)/1000,3)			                                    AS TOTAL_CAPACITY
        , IFNULL(COUNT(IFF(HISTORICAL_SITE, SITE_SK,NULL)),0)               ::INT	AS TOTAL_ACTIVE_SITES
        , ROUND(SUM(IFF(HISTORICAL_SITE, CAPACITY,0))/1000,3)                       AS TOTAL_ACTIVE_CAPACITY
    	, ROUND(IFNULL(SUM(IFF(CAPACITY >= 200,CAPACITY, 0))/1000,0),3)	    	    AS ACTUAL_MWP
    	, IFNULL(COUNT(IFF(CAPACITY < 200, SITE_SK, NULL)),0)               ::INT   AS ACTUAL_SITES
    FROM {{ ref('core_dim_site') }} PO
    WHERE PORTAL = 'Solytic 2.0'
    GROUP BY COMPANY_SK

)

SELECT
    cdc.COMPANY_ID
	, cdc.COMPANY_NAME
	, si.TOTAL_SITES
    , si.TOTAL_CAPACITY
	, si.TOTAL_ACTIVE_SITES
	, si.TOTAL_ACTIVE_CAPACITY
	, IFNULL(lo.LAST_LOGIN, '2000-01-01')                               AS LAST_LOGIN
    , IFNULL(c.SIGNED_SITES,0)- si.ACTUAL_SITES                 ::INT   AS DIFF_SITES_CONTRACTED_VS_CREATED
    , ROUND(IFNULL(c.SIGNED_MWP,0) - si.ACTUAL_MWP,3)                   AS DIFF_MWP_CONTRACTED_VS_CREATED
FROM SITES si
LEFT JOIN {{ ref('core_dim_company') }} cdc USING (COMPANY_SK)
LEFT JOIN LOGINS lo ON si.COMPANY_SK = lo.OPERATIONAL_COMPANY_SK
LEFT JOIN CONTRACTS c USING (COMPANY_SK)
WHERE cdc.COMPANY_ID IS NOT NULL
    -- NOTE: EXCLUDE KOSTAL
    AND cdc.COMPANY_ID NOT IN (911300494, -1)




