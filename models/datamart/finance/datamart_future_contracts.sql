
{{ config(
    tags=["companies", "deals"]
) }}

WITH relevant_deals AS (

	SELECT DD.DEAL_SK
		, IFNULL(DD.COMPANY_SK	, -1) 										AS COMPANY_SK
		, DD.CONTRACT_START_DATE
		, DD.CONTRACT_END_DATE
		, CASE 	DD.PAYMENT_PERIOD
			WHEN 'yearly' 		THEN 12
			WHEN 'quarterly' 	THEN 4
			WHEN 'one time' 	THEN 0
			WHEN ''		 		THEN 0
			WHEN 'monthly' 		THEN 1
			WHEN 'biyearly' 	THEN 6
			ELSE 0
		END																	AS PAYMENT_OCCURRENCE	-- NOTE: EVERY X MONTHS
		, iFF( DD.PAYMENT_PERIOD IN ('one time', '')
			OR DD.PAYMENT_PERIOD IS NULL , 0, DD.ANNUAL_RECURRING_REVENUE)	AS ARR
		, DD.CONTRACT_NOTICE_PERIOD
		, DD.AUTOMATIC_RENEWAL
		, DD.AUTOMATIC_RENEWAL_PERIOD
		, DD.ANNUAL_RECURRING_REVENUE
		, DD.ANNUAL_CONTRACT_VALUE
		, DD.MONTHLY_RECURRING_REVENUE
		, IFF( DD.PAYMENT_PERIOD = 'ONE TIME'
			AND DD.ONE_OFF_VALUE IS NULL, DD.ANNUAL_CONTRACT_VALUE, DD.ONE_OFF_VALUE) 		AS ONE_OFF_VALUE
		, DD.PAYMENT_PERIOD
	FROM {{ ref('core_dim_deal') }} dd
	WHERE DD.IS_WON = TRUE
		AND DD.ACTIVE_INDICATOR = TRUE
		AND CURRENT_DATE BETWEEN DD.CONTRACT_START_DATE
			AND DD.CONTRACT_END_DATE

)

, CTE2 AS (
	SELECT CTE.DEAL_SK
		, CTE.COMPANY_SK
		, CTE.PAYMENT_OCCURRENCE
		, CTE.CONTRACT_START_DATE 		AS SINGLE_DATE
		, CTE.CONTRACT_START_DATE
		, CTE.CONTRACT_END_DATE
		, CTE.PAYMENT_PERIOD
		, CTE.ARR
		, CTE.ANNUAL_RECURRING_REVENUE
		, CTE.ONE_OFF_VALUE
	FROM RELEVANT_DEALS CTE
	UNION ALL
	SELECT CTE2.DEAL_SK
		, CTE2.COMPANY_SK
		, CTE2.PAYMENT_OCCURRENCE
		, DATEADD(MONTH, PAYMENT_OCCURRENCE, CTE2.SINGLE_DATE )
		, CTE2.CONTRACT_START_DATE
		, CTE2.CONTRACT_END_DATE
		, CTE2.PAYMENT_PERIOD
		, CTE2.ARR
		, CTE2.ANNUAL_RECURRING_REVENUE
		, CTE2.ONE_OFF_VALUE
	FROM CTE2
	WHERE DATEADD(MONTH, PAYMENT_OCCURRENCE, CTE2.SINGLE_DATE ) < CTE2.CONTRACT_END_DATE
		AND CTE2.PAYMENT_OCCURRENCE >= 1
)


, outstanding AS (
	SELECT	*
		, SINGLE_DATE > CURRENT_DATE()									AS OUTSTANDING
		, IFF(PAYMENT_OCCURRENCE <> 0, ARR/(12/PAYMENT_OCCURRENCE), 0) 	AS AMOUNT_PER_PAYMENT
	FROM CTE2
)

SELECT DEAL_SK												AS DEAL_SK
	, COMPANY_SK											AS COMPANY_SK
	, CONTRACT_START_DATE									AS CONTRACT_START_DATE
	, CONTRACT_END_DATE										AS CONTRACT_END_DATE
	, PAYMENT_PERIOD										AS PAYMENT_PERIOD
	, MAX(ANNUAL_RECURRING_REVENUE)							AS ANNUAL_RECURRING_REVENUE
	, SUM(IFF(OUTSTANDING= TRUE, 0, 1)) 					AS PAID_INSTALLMENTS
	, SUM(IFF(OUTSTANDING= TRUE, 0, AMOUNT_PER_PAYMENT)) 	AS PAID_VALUE
	, SUM(OUTSTANDING::INT) 								AS OUTSTANDING_INSTALLMENTS
	, SUM(IFF(OUTSTANDING= TRUE, AMOUNT_PER_PAYMENT, 0)) 	AS OUTSTANDING_VALUE
	, COUNT(OUTSTANDING) 									AS TOTAL_INSTALLMENTS
	, SUM(AMOUNT_PER_PAYMENT) 								AS TOTAL_RECURRING_VALUE
	, MAX(ONE_OFF_VALUE)									AS ONE_OFF_VALUE
	, SUM(AMOUNT_PER_PAYMENT) + MAX(ONE_OFF_VALUE)			AS TOTAL_CONTRACT_VALUE
	, MAX(AMOUNT_PER_PAYMENT)								AS AMOUNT_PER_PAYMENT
FROM OUTSTANDING
GROUP BY DEAL_SK
	, COMPANY_SK
	, CONTRACT_START_DATE
	, CONTRACT_END_DATE
	, PAYMENT_PERIOD