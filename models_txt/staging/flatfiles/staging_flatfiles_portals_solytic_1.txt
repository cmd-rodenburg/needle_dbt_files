WITH S1_RENAME AS (

	SELECT
		SITE_ID
		, NULLIF(TRIM(IFNULL(ren.HUBSPOT_NAME, CUSTOMER)), '') 									AS COMPANY_NAME
		, LAST_VALUE(TRIM(SITE_NAME)) OVER (PARTITION BY SITE_ID ORDER BY ENTRY_DATE ) 			AS SITE_NAME
		, LAST_VALUE(CAPACITY) OVER (PARTITION BY SITE_ID ORDER BY ENTRY_DATE )					AS CAPACITY
		, IFF(TRY_TO_DOUBLE(LATITUDE) BETWEEN 1 AND -1, NULL, TRY_TO_DOUBLE(LATITUDE)) 			AS LATITUDE_
		, IFF(TRY_TO_DOUBLE(LONGITUDE) BETWEEN 1 AND -1, NULL, TRY_TO_DOUBLE(LONGITUDE)) 		AS LONGITUDE_
		, LAST_CONTACT
		, ENTRY_DATE																			AS LAST_ENTRY_
		, LEAST(MIN(ENTRY_DATE ) OVER (PARTITION BY SITE_ID), LAST_CONTACT)						AS CREATE_DATE
		, LAST_VALUE(NUMBER_OF_ACTIVE_DEVICES) OVER (PARTITION BY SITE_ID ORDER BY ENTRY_DATE )	AS NUMBER_OF_DEVICES
	FROM {{ source('flatfiles', 'portal_solytic_1') }} s1
	-- NOTE: RENAME S1 CUSTOMERS TO SET UP LINK TO HUBSPOT
	LEFT JOIN {{ source('flatfiles', 's1_renaming') }} ren ON CUSTOMER = S1_NAME

)
, S1_COORDINATES AS (

	SELECT SITE_ID
		, MAX(COMPANY_NAME) 															AS COMPANY_NAME
		, SITE_NAME
		, CAPACITY
		, MAX(LATITUDE_)																AS LATITUDE
		, MAX(LONGITUDE_) 																AS LONGITUDE
		, TO_GEOGRAPHY(CONCAT('POINT(', MAX(LONGITUDE_),' ', MAX(LATITUDE_), ')' )) 	AS COORDINATES
		, MAX(LAST_CONTACT)	 															AS LAST_CONTACT
		, NUMBER_OF_DEVICES
		-- NOTE: SITES THAT NEVER SENT DATA ARE "REGISTERED", WHILE DATA SENDING SITES ARE "HISTORICALLY ACTIVE"
		, IFF(MAX(LAST_CONTACT)	IS NULL, FALSE, TRUE) 	 			 					AS HISTORICAL_SITE
		, IFNULL(DATEDIFF(day, MAX(LAST_ENTRY_), MAX(LAST_CONTACT)) <=31, FALSE)		AS LIVE_SITE
	FROM S1_RENAME
	GROUP BY SITE_ID
		, SITE_NAME
		, CAPACITY
		, NUMBER_OF_DEVICES

)

SELECT S1.SITE_ID
	, S1.COMPANY_NAME
	, S1.SITE_NAME
	, S1.CAPACITY
	, S1.LATITUDE
	, S1.LONGITUDE
	, S1.LAST_CONTACT
	, S1.NUMBER_OF_DEVICES
	, S1.HISTORICAL_SITE
	, S1.LIVE_SITE
	, FC.COUNTRY_ID
FROM S1_COORDINATES S1
LEFT JOIN {{ ref('staging_flatfiles_countries') }} FC ON st_contains(FC.COUNTRY_GEOGRAPHY , S1.coordinates) AND FC."LANGUAGE" = 'en'

