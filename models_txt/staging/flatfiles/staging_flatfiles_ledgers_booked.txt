WITH BASE AS (

	SELECT
		"Date_key"								AS DATE_KEY
		, "Account"								AS LEDGER_NUMBER
		, "Name"								AS LEDGER_NAME
		, "Class"								AS CLASS
		, "Sum_debit" 				::FLOAT		AS AMOUNT_DEBIT
		, "Sum_credit"				::FLOAT		AS AMOUNT_CREDIT
		, "Balance_debit"			::FLOAT		AS END_BALANCE_DEBIT
		, "Balance_credit"			::FLOAT		AS END_BALANCE_CREDIT
	    , CASE
			WHEN LEDGER_NUMBER = 1200						THEN 'Cash flow'
			When LEDGER_NUMBER = 1400						THEN 'Trade receivables'
			WHEN LEDGER_NUMBER = 1600						THEN 'Trade payables'
			WHEN LEDGER_NUMBER  = 4210 						THEN 'Rental expenses'
			WHEN CLASS = 3 						 			THEN 'Operational'
			WHEN LEDGER_NUMBER BETWEEN 4100 AND 4166		THEN 'Personal'
			WHEN LEDGER_NUMBER BETWEEN 4211 AND 5000	 	THEN 'Other'
			WHEN LEDGER_NUMBER  IN (8200,8336,8338,8400) 	THEN 'SAAS'
			WHEN LEDGER_NUMBER  IN (8202, 8351,8402) 		THEN 'Onboarding'
			WHEN LEDGER_NUMBER  IN (8401, 8801, 8820) 		THEN 'Project and one-off'
			END 																			AS COMPANY_REPORT_CATEGORY
		, CASE
			WHEN LEDGER_NUMBER = 1200 					THEN 'Cash flow'
			When LEDGER_NUMBER = 1400					THEN 'Trade receivables'
			WHEN LEDGER_NUMBER = 1600					THEN 'Trade payables'
			WHEN COMPANY_REPORT_CATEGORY IS NOT NULL AND CLASS = 8 	THEN 'Revenue'
			WHEN COMPANY_REPORT_CATEGORY IS NOT NULL 	THEN 'Costs'
		END														AS BI_CATEGORY
FROM {{ source('flatfiles', 'ledgers_booked') }}
	WHERE LEDGER_NAME NOT LIKE 'Summe Klasse %'

)

SELECT DATE_KEY
	, CLASS AS LEDGER_NUMBER
	, CONCAT('Class sum ', CLASS) AS LEDGER_NAME_
	, CLASS
	, SUM(AMOUNT_DEBIT) AS AMOUNT_DEBIT
	, SUM(AMOUNT_CREDIT) AS AMOUNT_CREDIT
	, SUM(END_BALANCE_DEBIT)	AS END_BALANCE_DEBIT
	, SUM(END_BALANCE_CREDIT)	AS END_BALANCE_CREDIT
	, COMPANY_REPORT_CATEGORY
	, BI_CATEGORY
FROM BASE
GROUP BY DATE_KEY
	, CLASS
	, COMPANY_REPORT_CATEGORY
	, BI_CATEGORY