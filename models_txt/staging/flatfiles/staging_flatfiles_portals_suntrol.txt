SELECT sun.SITE_ID
	, sun.SITE_NAME
	, sun.CAPACITY
	, IFF(sun.LATITUDE between 1 and -1, NULL, sun.LATITUDE)					AS LATITUDE
	, IFF(sun.LONGITUDE between 1 and -1, NULL, sun.LONGITUDE)					AS LONGITUDE
	, TO_GEOGRAPHY(CONCAT('POINT(', sun.LONGITUDE,' ', sun.LATITUDE, ')' ))		AS COORDINATES
	, COALESCE(FC1.COUNTRY_ID, FC2.COUNTRY_ID, -1 )								AS COUNTRY_ID
	, sun.LAST_CONTACT
	, sun.NUMBER_OF_DEVICES
	-- NOTE: SITES THAT NEVER SENT DATA ARE "REGISTERED", WHILE HISTORICALLY ACTIVE SITES ARE "HistoricalLY ACTIVE"
	, IFF(sun.LAST_CONTACT IS NULL, FALSE, TRUE) 								AS HISTORICAL_SITE
	, IFF(DATEDIFF(day, sun.LAST_CONTACT, sun.ENTRY_DATE) <=31, TRUE, FALSE) 	AS LIVE_SITE
FROM (
	SELECT *
		, ROW_NUMBER() OVER (PARTITION BY SITE_ID ORDER BY ENTRY_DATE DESC) AS ROW_
	FROM {{ source('flatfiles', 'portal_suntrol') }} sun
) sun
LEFT JOIN {{ ref('staging_flatfiles_countries') }} FC1 ON FC1."LANGUAGE" = 'en' AND st_contains(FC1.COUNTRY_GEOGRAPHY , coordinates)
LEFT JOIN {{ ref('staging_flatfiles_countries') }} FC2 ON FC2."LANGUAGE" = 'en' AND FC2.COUNTRY_ALPHA_2_CODE = sun.COUNTRY
WHERE ROW_ = 1