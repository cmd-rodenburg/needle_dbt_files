-- NOTE: CURRENT OUTSTANDING SEPA TRANSFERS

WITH RECEIPTS AS (

	SELECT 
		 DESCRIPTION
		, DEBTORS_CREDITORS_ID
		, SUM(GROSS_AMOUNT*100) ::INT AS GROSS_AMOUNT 
		, Date_KEY
		, DUE_DATE
	FROM {{ ref('core_fact_expenses_invoiced') }} 
    	WHERE PAYMENT_STATUS = 'Unpaid/Due' 
		AND LINE_ITEM_DESCRIPTION LIKE 'SC - %'
		AND RECURRENCE = 'One-off'
	GROUP BY
		DESCRIPTION
		, DEBTORS_CREDITORS_ID
		, RECEIPT_ID 
		, DATE_KEY
		, DUE_DATE

)

SELECT
	DC.DEBTORS_CREDITORS_NAME
	, RP.DESCRIPTION
	, RP.GROSS_AMOUNT               
	, RP.DATE_KEY
	, RP.DUE_DATE
	, DC.IBAN
	, DC.BIC
	, DC.DEBTORS_CREDITORS_NUMBER
FROM RECEIPTS RP 
LEFT JOIN {{ ref('core_dim_debtor_creditor') }}  DC ON RP.DEBTORS_CREDITORS_ID = DC.DEBTORS_CREDITORS_ID 

 