{{ config(
    tags=["companies"]
) }}

WITH  INVOICED_REVENUE AS (

	SELECT
		SSI.INVOICE_ID
		, SSI.DATE_KEY
		, SSI.INVOICE_NUMBER
		, IFNULL(CDD.DEAL_SK, -1) 						AS DEAL_SK
		, COALESCE(CDD.COMPANY_SK, CDC.COMPANY_SK, -1) 	AS COMPANY_SK
		, PAID_INDICATOR
		, SUM(NET_AMOUNT)								AS INVOICE_REVENUE
		, SUM(TOTAL_DISCOUNT)							AS TOTAL_DISCOUNT
		, COUNT(*)										AS LINE_ITEMS
	FROM {{ ref('staging_sevdesk_invoices') }} SSI
	LEFT JOIN {{ ref('core_dim_deal') }} CDD ON SSI.DEAL_ID = CDD.DEAL_ID AND CDD.ACTIVE_INDICATOR = TRUE
	LEFT JOIN {{ ref('core_dim_company') }} CDC ON CDC.COMPANY_ID = SSI.HUBSPOT_COMPANY_ID
	GROUP BY
		SSI.INVOICE_ID
		, SSI.DATE_KEY
		, SSI.INVOICE_NUMBER
		, IFNULL(CDD.DEAL_SK, -1)
		, COALESCE(CDD.COMPANY_SK, CDC.COMPANY_SK, -1)
		, PAID_INDICATOR

)

, BOOKED_REVENUE AS (

	SELECT DISTINCT
		DATE_KEY 				AS DATE_KEY
		, INVOICE_NUMBER
		, SUM(TOTAL_CREDIT) 	AS BOOKED_CREDIT
		, SUM(TOTAL_DEBIT) 		AS BOOKED_DEBIT
	FROM {{ ref('staging_flatfiles_booked_revenue') }}
	GROUP BY DATE_KEY
		, INVOICE_NUMBER

)


SELECT
	IFNULL(IR.DATE_KEY, BR.DATE_KEY) 					AS DATE_KEY
	, IR.DEAL_SK 										AS DEAL_SK
	, IFNULL(IR.COMPANY_SK, -1)							AS COMPANY_SK
	, IFNULL(IR.INVOICE_NUMBER, BR.INVOICE_NUMBER) 		AS INVOICE_NUMBER
	, BR.BOOKED_CREDIT									AS BOOKED_CREDIT
	, BR.BOOKED_DEBIT									AS BOOKED_DEBIT
	, IR.PAID_INDICATOR									AS PAID_INDICATOR
	, IR.INVOICE_REVENUE								AS INVOICE_REVENUE
	, IR.TOTAL_DISCOUNT									AS TOTAL_DISCOUNT
	, IR.LINE_ITEMS										AS LINE_ITEMS
FROM INVOICED_REVENUE IR
FULL OUTER JOIN BOOKED_REVENUE BR USING (INVOICE_NUMBER)
