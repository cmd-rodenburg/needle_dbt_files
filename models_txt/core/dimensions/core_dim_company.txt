{{ config(
    tags=["companies"]
) }}

WITH solytic_2 AS (

	SELECT COMPANY_ID
		, COUNT(DISTINCT SITE_ID) 				AS SOLYTIC_2_SITES
	FROM {{ ref('staging_operation_sites') }}
	GROUP BY COMPANY_ID

), solytic_1 AS (

	SELECT s1.COMPANY_NAME
		, COUNT(s1.SITE_ID)						AS SOLYTIC_1_SITES
	FROM {{ ref('staging_flatfiles_portals_solytic_1') }}  s1
	GROUP BY s1.COMPANY_NAME
)
, CONTRACT_START_END AS (
	SELECT COMPANY_ID
		, MIN(CONTRACT_START_DATE)				AS COMPANY_START_DATE
		, LAST_DAY(MAX(CONTRACT_END_DATE)) 		AS COMPANY_END_DATE
	FROM {{ ref('staging_hubspot_deals') }} shd
	LEFT JOIN (
		SELECT DISTINCT STAGE_ID , STAGE_NAME
		FROM {{ ref('staging_hubspot_pipelines') }}
		WHERE STAGE_NAME  IN ( 'Contract Ended','Won')
		) SHP ON SHP.STAGE_ID = SHD.DEAL_STAGE_ID
	WHERE shd.ACTIVE_INDICATOR = TRUE
		AND CONTRACT_START_DATE IS NOT NULL
		AND CONTRACT_END_DATE IS NOT NULL
	GROUP BY COMPANY_ID
)

SELECT
	DENSE_RANK () OVER (ORDER BY COALESCE(shc.COMPANY_ID ::VARCHAR, soc.COMPANY_ID::VARCHAR, s1.COMPANY_NAME))		AS COMPANY_SK
	, IFNULL(shc.COMPANY_ID,-1)													AS COMPANY_ID
	, COALESCE(shc.COMPANY_NAME, soc.COMPANY_NAME, s1.COMPANY_NAME)				AS COMPANY_NAME
	, cse.COMPANY_START_DATE													AS COMPANY_START_DATE
	, cse.COMPANY_END_DATE														AS COMPANY_END_DATE
	, shc.COUNTRY											 					AS COUNTRY
	, shc.INDUSTRY											 					AS INDUSTRY
	, shc.TARR												 					AS TARR
	, shc.SEGMENT_REVENUE								 						AS SEGMENT_REVENUE
	, shc.SEGMENT_POTENTIAL							 							AS SEGMENT_POTENTIAL
	, shc.CURRENT_CUSTOMER														AS CURRENT_CUSTOMER
	, shc.LIFECYCLESTAGE								 						AS LIFECYCLESTAGE
	, shc.MWP_PLANNED									 						AS MWP_PLANNED
	, shc.MWP_CURRENT									 						AS MWP_CURRENT
	, NULLIF(CONCAT(
		IFF(s2.SOLYTIC_2_SITES > 0, 'Solytic 2.0;', ''),
		IFF(s1.SOLYTIC_1_SITES > 0, 'Solytic 1.0;', '')), '')					AS PORTALS
	, IFF(shc.PORTAL_USED LIKE '%whitelabel%',TRUE, FALSE)						AS WHITELABEL_INDICATOR
	, IFF(s1.SOLYTIC_1_SITES > 0 , TRUE, FALSE)									AS SOLYTIC_1_0_INDICATOR
	, IFF(s2.SOLYTIC_2_SITES > 0, TRUE, FALSE) 									AS SOLYTIC_2_0_INDICATOR
	, shc.MWP_SIGNED_TOTAL														AS MWP_SIGNED_TOTAL
	, shc.POTENTIAL_IN_MWP														AS POTENTIAL_IN_MWP
	, shc.HUBSPOT_OWNER_ID														AS HUBSPOT_OWNER_ID
	, soc.COMPANY_ID															AS OPERATIONAL_ID
	, shc.SEVDESK_CUSTOMER_ID													AS SEVDESK_CUSTOMER_ID
	, soc.ACCOUNT_TYPE															AS ACCOUNT_TYPE
	, s2.SOLYTIC_2_SITES														AS ACTUAL_SOLYTIC_2_SITES
	, s1.SOLYTIC_1_SITES														AS ACTUAL_SOLYTIC_1_SITES
	, shc.SITES_2_CREATED														AS SITES_2_CREATED
	, shc.MUST_HAVE_FEATURE														AS MUST_HAVE_FEATURE
	, shc.NICE_TO_HAVE_FEATURE													AS NICE_TO_HAVE_FEATURE
	, shc.NUM_DEALS																AS NUM_HUBSPOT_DEALS
FROM {{ ref('staging_hubspot_companies') }} shc
FULL OUTER JOIN {{ ref('staging_operation_companies') }} soc ON shc.COMPANY_ID = soc.HUBSPOT_COMPANY_ID
LEFT JOIN solytic_2 s2 ON s2.COMPANY_ID = soc.COMPANY_ID
FULL OUTER JOIN  solytic_1 s1 ON lower(s1.COMPANY_NAME) = lower(IFNULL(shc.COMPANY_NAME, soc.COMPANY_NAME))
LEFT JOIN CONTRACT_START_END cse ON shc.COMPANY_ID = cse.COMPANY_ID

UNION ALL

-- DEFAULT UNKNOWN VALUE
SELECT -1 		AS COMPANY_SK
	, -1		AS COMPANY_ID
	, 'UNKNOWN' AS COMPANY_NAME
	, NULL 		AS COMPANY_START_DATE
	, NULL 		AS COMPANY_END_DATE
	, NULL 		AS COUNTRY
	, NULL 		AS INDUSTRY
	, NULL 		AS TARR
	, NULL 		AS SEGMENT_REVENUE
	, NULL 		AS SEGMENT_POTENTIAL
	, NULL 		AS CURRENT_CUSTOMER
	, NULL 		AS LIFECYCLESTAGE
	, NULL 		AS MWP_PLANNED
	, NULL 		AS MWP_CURRENT
	, NULL 		AS PORTAL_USED
	, NULL 		AS WHITELABEL_INDICATOR
	, NULL 		AS SOLYTIC_1_0_INDICATOR
	, NULL 		AS SOLYTIC_2_0_INDICATOR
	, NULL 		AS MWP_SIGNED_TOTAL
	, NULL 		AS POTENTIAL_IN_MWP
	, NULL 		AS HUBSPOT_OWNER_ID
	, NULL 		AS OPERATIONAL_ID
	, NULL		AS SEVDESK_CUSTOMER_ID
	, NULL 		AS ACCOUNT_TYPE
	, NULL 		AS ACTUAL_SOLYTIC_2_SITES
	, NULL 		AS ACTUAL_SOLYTIC_1_SITES
	, NULL 		AS SITES_2_CREATED
	, NULL 		AS MUST_HAVE_FEATURE
	, NULL 		AS NICE_TO_HAVE_FEATURE
	, NULL		AS NUM_HUBSPOT_DEALS
